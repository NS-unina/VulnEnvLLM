# Use a base image with necessary dependencies for building
FROM ubuntu:20.04
ENV DEBIAN_FRONTEND=noninteractive

# Install required dependencies
RUN apt-get update && \
    apt-get install -y acl attr autoconf bind9utils bison build-essential \
    debhelper dnsutils docbook-xml docbook-xsl flex gdb libjansson-dev krb5-user \
    libacl1-dev libaio-dev libarchive-dev libattr1-dev libblkid-dev libbsd-dev \
    libcap-dev libcups2-dev libgnutls28-dev libgpgme-dev libjson-perl \
    libldap2-dev libncurses5-dev libpam0g-dev libparse-yapp-perl \
    libpopt-dev libreadline-dev nettle-dev perl perl-modules pkg-config \
    python-all-dev python-crypto python2-dbg python-dev python-dnspython \
    python3-dnspython python3-gpg python-markdown python3-markdown \
    python3-dev xsltproc zlib1g-dev liblmdb-dev lmdb-utils wget

# Download and extract the Samba source code
RUN wget https://download.samba.org/pub/samba/samba-4.4.16.tar.gz && \
    tar -xzvf samba-4.4.16.tar.gz && \
    cd samba-4.4.16

# Configure and build Samba
RUN cd samba-4.4.16 && \
    ./configure && \
    make && \
    make install

ENV PATH="/usr/local/samba/bin:/usr/local/samba/sbin:${PATH}"
COPY smb.conf /usr/local/samba/etc/smb.conf

# Expose the default Samba ports
EXPOSE 137/udp 138/udp 139/tcp 445/tcp

RUN (echo test; echo test) | smbpasswd -s -a root

# Set the entry point
ENTRYPOINT ["smbd", "--foreground", "--no-process-group"]