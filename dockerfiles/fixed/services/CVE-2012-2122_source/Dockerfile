# Use a base image with necessary build tools
FROM ubuntu:20.04
ENV DEBIAN_FRONTEND=noninteractive
# Install dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    git \
    libncurses5-dev \
    libssl-dev \
    zlib1g-dev \
    libboost-all-dev \
    wget \
    && rm -rf /var/lib/apt/lists/*

RUN wget http://launchpadlibrarian.net/140087283/libbison-dev_2.7.1.dfsg-1_amd64.deb && wget http://launchpadlibrarian.net/140087282/bison_2.7.1.dfsg-1_amd64.deb
RUN dpkg -i libbison-dev_2.7.1.dfsg-1_amd64.deb && dpkg -i bison_2.7.1.dfsg-1_amd64.deb && rm libbison-dev_2.7.1.dfsg-1_amd64.deb bison_2.7.1.dfsg-1_amd64.deb


RUN groupadd mysql && useradd -r -g mysql -s /bin/false mysql
# Clone MySQL source from GitHub
RUN git clone --depth=1 --branch mysql-5.6.5 https://github.com/mysql/mysql-server.git /mysql

#ENV CFLAGS="-std=c++0x"
# Build MySQL Server
WORKDIR /mysql
RUN mkdir bld && cd bld && cmake .. -DCMAKE_CXX_FLAGS="-std=c++03" && make && make install

# Cleanup
RUN rm -rf /mysql
RUN cd /usr/local/mysql && \
    mkdir mysql-files && \
    chown mysql:mysql mysql-files && chmod 750 mysql-files
RUN bin/mysqld --initialize --user=mysql && bin/mysql_ssl_rsa_setup
# bin/mysqld_safe --user=mysql &
# Expose MySQL port
EXPOSE 3306

# Set default command to run MySQL Server
CMD ["mysqld"]