# Use a base image with the necessary tools and libraries
FROM alpine:latest

# Install required packages
RUN apk update && apk add --no-cache \
    build-base \
    ca-certificates \
    wget \
    gnupg \
    libevent-dev \
    libtool \
    autoconf \
    automake \
    gettext \
    db-dev \
    mariadb-dev \
    postgresql-dev \
    sqlite-dev \
    libressl \
    curl-dev \
    cyrus-sasl-dev \
    linux-pam-dev \
    make
RUN apk add fts-dev byacc

RUN wget https://www.opensmtpd.org/archives/libasr-1.0.4.tar.gz && \
    tar -zxvf libasr-1.0.4.tar.gz && \
    rm -f libasr-1.0.4.tar.gz

RUN cd libasr-1.0.4 && \
    ./bootstrap && \
    ./configure && \
    make && \
    make install
# Download OpenSMTPD source code
RUN wget https://github.com/OpenSMTPD/OpenSMTPD/releases/download/6.6.1p1/opensmtpd-6.6.1p1.tar.gz && \
    tar -zxvf opensmtpd-6.6.1p1.tar.gz && \
    rm -f opensmtpd-6.6.1p1.tar.gz

WORKDIR /opensmtpd-6.6.1p1

RUN ./bootstrap && \
    ./configure && \
    make && \
    make install

# Clean up unnecessary packages and files
RUN apk del build-base \
    libressl-dev \
    wget \
    gnupg \
    libtool \
    autoconf \
    automake \
    gettext \
    db-dev \
    mariadb-dev \
    postgresql-dev \
    sqlite-dev \
    libressl \
    curl-dev \
    cyrus-sasl-dev \
    linux-pam-dev && \
    rm -rf /var/cache/apk/* && \
    rm -rf /OpenSMTPD-opensmtpd-6.6.1p1

COPY smtpd.conf /usr/local/etc/smtpd.conf
# Expose SMTP port
EXPOSE 25

# Create a system user for OpenSMTPD
RUN adduser -D -h /var/mail _smtpq
RUN adduser -D -h /var/mail _smtpd

# Run OpenSMTPD
CMD ["smtpd", "-dv"]