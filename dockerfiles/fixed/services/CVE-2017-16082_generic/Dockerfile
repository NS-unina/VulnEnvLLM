# Use official Node.js 9.0.0 image as base
FROM node:9.0.0

RUN echo "deb http://archive.debian.org/debian/ stretch main contrib non-free" > /etc/apt/sources.list && \
    echo "deb http://archive.debian.org/debian/ stretch-proposed-updates main contrib non-free" >> /etc/apt/sources.list && \
    echo "deb http://archive.debian.org/debian-security stretch/updates main contrib non-free" >> /etc/apt/sources.list
# Set working directory within the container
WORKDIR /app

# Copy package.json and package-lock.json to the working directory
COPY package.json package-lock.json ./

# Install dependencies
RUN npm install

# Install PostgreSQL
RUN apt-get update && apt-get install -y postgresql postgresql-contrib

# Copy the rest of the application code
COPY . .

# Switch to the postgres user
USER postgres

# Initialize the database
RUN /etc/init.d/postgresql start &&\
    createdb -O postgres example &&\
    psql example < db.sql &&\
    psql -c "ALTER USER postgres WITH PASSWORD 'postgres';"
    

# Expose node port
EXPOSE 3000

# Start PostgreSQL service
CMD service postgresql start && sleep 10 && npm start

