#include <stdio.h>
#include <stdlib.h>
#include <libssh/libssh.h>

int authenticate_client(ssh_session session) {
    ssh_message message;
    int auth_success = 0;

    // Wait for authentication requests
    do {
        message = ssh_message_get(session);
        if (message) {
            switch (ssh_message_type(message)) {
                case SSH_REQUEST_AUTH:
                    // Authenticate the user
                    switch (ssh_message_subtype(message)) {
                        case SSH_AUTH_METHOD_NONE:
                            // Allow authentication without credentials
                            ssh_message_auth_reply_success(message, 0);
                            break;
                        default:
                            // Reject other authentication methods
                            ssh_message_reply_default(message);
                            break;
                    }
                    ssh_message_free(message);
                    break;
                default:
                    // Respond to other message types
                    ssh_message_reply_default(message);
                    ssh_message_free(message);
                    break;
            }
        } else {
            // Error handling for no message received
            break;
        }
    } while (!auth_success && ssh_get_status(session) != SSH_CLOSED);

    return auth_success;
}

void handle_client(ssh_session session) {
    ssh_message message;
    int auth_result;

    // Authenticate the client
    auth_result = authenticate_client(session);
    if (auth_result != SSH_OK) {
        fprintf(stderr, "Authentication failed\n");
        return;
    }

    // Connection authenticated, now handle data exchange
    do {
        message = ssh_message_get(session);
        if (message) {
            // Print received data from the client
            printf("Received: %s\n", ssh_message_auth_user(message));
            ssh_message_reply_default(message);
            ssh_message_free(message);
        } else {
            // Error handling for no message received
            break;
        }
    } while (ssh_get_status(session) != SSH_CLOSED);
}

int main() {
    ssh_bind sshbind;
    ssh_session session;
    int port = 2222; // Change to desired port

    // Initialize libssh
    sshbind = ssh_bind_new();
    if (ssh_bind_options_set(sshbind, SSH_BIND_OPTIONS_BINDPORT_STR, "2222") != SSH_OK) {
        fprintf(stderr, "Failed to set bind port\n");
        exit(EXIT_FAILURE);
    }

    // Start listening on the specified port
    if (ssh_bind_listen(sshbind) < 0) {
        fprintf(stderr, "Failed to listen on port %d\n", port);
        exit(EXIT_FAILURE);
    }

    printf("Server listening on port %d\n", port);

    // Accept incoming connections and handle them
    while (1) {
        session = ssh_new();
        if (ssh_bind_accept(sshbind, session) != SSH_OK) {
            fprintf(stderr, "Failed to accept incoming connection\n");
            exit(EXIT_FAILURE);
        }

        printf("Connection accepted\n");

        // Handle the client connection
        handle_client(session);

        // Free the session
        ssh_disconnect(session);
        ssh_free(session);
    }

    // Close the SSH bind
    ssh_bind_free(sshbind);

    return 0;
}