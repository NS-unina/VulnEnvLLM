# Use a base image with necessary dependencies
FROM ubuntu:20.04

# Update package list and install necessary tools
RUN apt-get update && \
    apt-get install -y wget build-essential git 

# Create a directory for PostgreSQL source code
WORKDIR /opt

# Clone PostgreSQL source code from the official repository
RUN git clone --branch REL_11_1 --depth 1 https://github.com/postgres/postgres.git

RUN apt-get install -y libreadline-dev zlib1g-dev bison flex

# Change to PostgreSQL source code directory
WORKDIR /opt/postgres

# Configure, build and install PostgreSQL
RUN ./configure && \
    make && \
    make install

# Expose PostgreSQL port
EXPOSE 5432

# Initialize a directory for data storage
RUN mkdir -p /var/lib/postgresql/data

# Create a postgres user and group
RUN groupadd -r postgres && useradd -r -g postgres postgres

# Set permissions for data directory
RUN chown -R postgres:postgres /var/lib/postgresql/data

# Switch to postgres user
USER postgres

# Initialize the database cluster
RUN /usr/local/pgsql/bin/initdb -D /var/lib/postgresql/data

# Set the password for the postgres user
RUN /usr/local/pgsql/bin/pg_ctl -D /var/lib/postgresql/data start && \
    /usr/local/pgsql/bin/psql -c "ALTER USER postgres PASSWORD 'postgres';" && \
    /usr/local/pgsql/bin/pg_ctl -D /var/lib/postgresql/data stop

COPY postgresql.conf /usr/local/pgsql/postgresql.conf
COPY pg_hba.conf /var/lib/postgresql/data/pg_hba.conf

# Start PostgreSQL server
CMD ["/usr/local/pgsql/bin/postgres", "-D", "/var/lib/postgresql/data", "-c", "config_file=/usr/local/pgsql/postgresql.conf"]