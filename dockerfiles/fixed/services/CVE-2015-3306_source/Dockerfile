# Use a base image with the necessary dependencies to build ProFTPd from source
FROM debian:buster AS builder

# Install build dependencies
RUN apt-get update && \
    apt-get install -y \
    build-essential \
    wget \
    libncurses-dev \
    libssl-dev \
    libpam0g-dev \
    zlib1g-dev \
    libwrap0-dev \
    libcap-dev \
    libmariadb-dev \
    libldap2-dev \
    libpq-dev \
    libsqlite3-dev

# Download and extract ProFTPd source
WORKDIR /tmp
RUN wget ftp://ftp.proftpd.org/distrib/source/proftpd-1.3.5.tar.gz && \
    tar -zxvf proftpd-1.3.5.tar.gz

RUN groupadd proftpd && \
    useradd -ms /bin/bash -g proftpd proftpd 
# Build ProFTPd with mod_copy
WORKDIR /tmp/proftpd-1.3.5
RUN install_user=proftpd install_group=proftpd ./configure --with-modules=mod_copy && \
    make && \
    make install

# Start a new image
FROM debian:buster

RUN groupadd proftpd && \
    useradd -ms /bin/bash -g proftpd proftpd 
# Install runtime dependencies
RUN apt-get update && \
    apt-get install -y \
    libssl1.1 \
    libpam0g \
    libwrap0 \
    libcap2 \
    libldap-2.4-2 \
    libpq5 \
    libsqlite3-0

# Copy ProFTPd binaries and configuration files from builder image
COPY --from=builder /usr/local/sbin/proftpd /usr/local/sbin/
COPY --from=builder /usr/local/etc/proftpd.conf /usr/local/etc/

RUN echo "\n<IfModule mod_delay.c>\n  DelayEngine off\n</IfModule>" >> /usr/local/etc/proftpd.conf
RUN touch /usr/local/proftpd.scoreboard
RUN chown -R proftpd:proftpd /usr/local/sbin/proftpd && \
    chown -R proftpd:proftpd /usr/local/etc/proftpd.conf && \
    chown -R proftpd:proftpd /usr/local/proftpd.scoreboard
# Expose FTP ports
EXPOSE 80 21

# Run ProFTPd
CMD ["/usr/local/sbin/proftpd", "--nodaemon"]