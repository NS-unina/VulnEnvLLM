# Base image
FROM php:7.4-apache

# Set environment variables
ENV JOOMLA_VERSION 3-9-28
ENV MUSIC_COLLECTION_VERSION 3.0.3

# Install dependencies
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        unzip \
        libxml2-dev \
        zlib1g-dev \
        libzip-dev \
    && docker-php-ext-install \
        pdo_mysql \
        xml \
        zip \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Download and extract Joomla
RUN mkdir -p /usr/src/joomla \
    && curl -L https://downloads.joomla.org/cms/joomla3/${JOOMLA_VERSION}/Joomla_${JOOMLA_VERSION}-Stable-Full_Package.tar.gz | tar xz -C /usr/src/joomla --strip-components=1

# Download and extract Music Collection Component
RUN mkdir -p /usr/src/music_collection \
    && curl -L https://github.com/joachimesque/music_collection/releases/download/${MUSIC_COLLECTION_VERSION}/com_music_collection-${MUSIC_COLLECTION_VERSION}.zip -o /tmp/music_collection.zip \
    && unzip -d /usr/src/music_collection /tmp/music_collection.zip \
    && rm /tmp/music_collection.zip

# Move Music Collection Component to Joomla extensions directory
RUN mv /usr/src/music_collection /usr/src/joomla/media/com_music_collection

# Copy Joomla files to Apache document root
RUN rm -rf /var/www/html/*
# COPY --chown=www-data:www-data /usr/src/joomla /var/www/html

# Configure Apache
RUN a2enmod rewrite
# COPY apache2.conf /etc/apache2/apache2.conf

# Set permissions
RUN chown -R www-data:www-data /var/www/html \
    && chmod -R 755 /var/www/html

# Expose port
EXPOSE 80

# Start Apache
CMD ["apache2-foreground"]