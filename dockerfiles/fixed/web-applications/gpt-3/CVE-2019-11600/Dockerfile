# Use the official Ruby image with Node.js and Yarn
FROM ruby:2.5.8

# Set the Rails environment to production
ENV RAILS_ENV=production

# Install system dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        curl \
        nodejs \
        libpq-dev \
        postgresql-client \
        imagemagick \
        libmagickwand-dev \
    && rm -rf /var/lib/apt/lists/*

# Install OpenProject
RUN curl -sSL https://www.openproject.org/download/repositories/stable/Debian_9/Release.key | gpg --dearmor > /usr/share/keyrings/openproject-archive-keyring.gpg \
    && echo "deb [signed-by=/usr/share/keyrings/openproject-archive-keyring.gpg] http://dl.packager.io/srv/opf/openproject/stable/8.3/Debian/9/ openproject main" > /etc/apt/sources.list.d/openproject.list \
    && apt-get update && apt-get install -y openproject=8.3.1-20201029143849 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Expose OpenProject port
EXPOSE 6000

# Start OpenProject
CMD ["bash", "-c", "rm -f tmp/pids/server.pid && bundle exec rails server -b '0.0.0.0' -p 6000"]