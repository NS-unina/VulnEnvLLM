# Use the official Drupal image as the base
FROM drupal:8.5.0

RUN rm /etc/apt/sources.list

RUN echo "deb http://archive.debian.org/debian-security jessie/updates main" >> /etc/apt/sources.list.d/jessie.list

RUN echo "deb http://archive.debian.org/debian jessie main" >> /etc/apt/sources.list.d/jessie.list

# Install required PHP extensions
RUN apt-get --allow-unauthenticated update
RUN apt-get --allow-unauthenticated install -y \
        libjpeg62-turbo-dev zlib1g-dev libpq5=9.4.18-0+deb8u1 libssl-dev krb5-multidev comerr-dev libxml2=2.9.1+dfsg1-5+deb8u6 \
        libcomerr2=1.42.12-2+b1 libkrb5-3=1.12.1+dfsg-19+deb8u4 libk5crypto3=1.12.1+dfsg-19+deb8u4 libgssapi-krb5-2=1.12.1+dfsg-19+deb8u4 \
        libkadm5srv-mit9=1.12.1+dfsg-19+deb8u4 libkadm5clnt-mit9=1.12.1+dfsg-19+deb8u4 libjpeg62-turbo=1:1.3.1-12 zlib1g=1:1.2.8.dfsg-2+b1 \
        libkrb5support0 libkdb5-7 krb5-locales \
        libpng-dev \
        libjpeg-dev \
        libpq-dev \
        libxml2-dev
RUN docker-php-ext-configure gd --with-jpeg-dir=/usr/include/ \
    && docker-php-ext-install -j$(nproc) \
        gd \
        opcache \
        pdo_mysql \
        pdo_pgsql \
        mysqli \
        xml \
        mbstring \
        zip

# Install MariaDB server
RUN apt-get update && apt-get install -y mariadb-server

# Copy custom configuration files if needed
# COPY php.ini /usr/local/etc/php/
# COPY apache.conf /etc/apache2/sites-available/000-default.conf

# Expose ports
EXPOSE 80
EXPOSE 3306

# Set up entry point to start both Drupal and MariaDB
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]
