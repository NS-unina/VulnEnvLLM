# Use a base image with the necessary dependencies to build ProFTPd from source
FROM debian:buster AS builder

# Install build dependencies
RUN apt-get update && \
    apt-get install -y \
    build-essential \
    wget \
    libncurses-dev \
    libssl-dev \
    libpam0g-dev \
    zlib1g-dev \
    libwrap0-dev \
    libcap-dev \
    libmysqlclient-dev \
    libldap2-dev \
    libpq-dev \
    libsqlite3-dev

# Download and extract ProFTPd source
WORKDIR /tmp
RUN wget ftp://ftp.proftpd.org/distrib/source/proftpd-1.3.5.tar.gz && \
    tar -zxvf proftpd-1.3.5.tar.gz

# Build ProFTPd with mod_copy
WORKDIR /tmp/proftpd-1.3.5
RUN ./configure --with-modules=mod_copy && \
    make && \
    make install

# Start a new image
FROM debian:buster

# Install runtime dependencies
RUN apt-get update && \
    apt-get install -y \
    libssl1.1 \
    libpam0g \
    libwrap0 \
    libcap2 \
    libmysqlclient21 \
    libldap-2.4-2 \
    libpq5 \
    libsqlite3-0

# Copy ProFTPd binaries and configuration files from builder image
COPY --from=builder /usr/local/sbin/proftpd /usr/local/sbin/
COPY --from=builder /usr/local/libexec/proftpd /usr/local/libexec/
COPY --from=builder /usr/local/etc/proftpd.conf /usr/local/etc/

# Expose FTP ports
EXPOSE 20 21

# Run ProFTPd
CMD ["/usr/local/sbin/proftpd", "--nodaemon"]