# Use a base image with the necessary tools and libraries
FROM alpine:latest

# Install required packages
RUN apk add --no-cache \
    build-base \
    libressl-dev \
    ca-certificates \
    wget \
    gnupg \
    libasr-dev \
    libevent-dev \
    libtool \
    autoconf \
    automake \
    gettext \
    db-dev \
    mariadb-dev \
    postgresql-dev \
    sqlite-dev \
    libressl \
    curl-dev \
    cyrus-sasl-dev \
    linux-pam-dev \
    gmake

# Download OpenSMTPD source code
RUN wget https://github.com/OpenSMTPD/OpenSMTPD/archive/refs/tags/opensmtpd-6.6.4p1.tar.gz && \
    tar -zxvf opensmtpd-6.6.4p1.tar.gz && \
    rm -f opensmtpd-6.6.4p1.tar.gz

WORKDIR /OpenSMTPD-opensmtpd-6.6.4p1

# Configure, build and install OpenSMTPD
RUN ./bootstrap && \
    ./configure && \
    make && \
    make install

# Clean up unnecessary packages and files
RUN apk del build-base \
    libressl-dev \
    wget \
    gnupg \
    libasr-dev \
    libevent-dev \
    libtool \
    autoconf \
    automake \
    gettext \
    db-dev \
    mariadb-dev \
    postgresql-dev \
    sqlite-dev \
    libressl \
    curl-dev \
    cyrus-sasl-dev \
    linux-pam-dev \
    gmake && \
    rm -rf /var/cache/apk/* && \
    rm -rf /OpenSMTPD-opensmtpd-6.6.4p1

# Expose SMTP port
EXPOSE 25

# Run OpenSMTPD
CMD ["smtpd", "-dv"]