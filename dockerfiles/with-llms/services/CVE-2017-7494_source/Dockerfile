# Use a base image with necessary dependencies for building
FROM ubuntu:20.04

# Install required dependencies
RUN apt-get update && \
    apt-get install -y \
    build-essential \
    wget \
    python \
    python-dev \
    python3 \
    python3-dev \
    libacl1-dev \
    libattr1-dev \
    libblkid-dev \
    libgnutls28-dev \
    libreadline-dev \
    python3-dbg \
    python-dbg \
    python3-gpg \
    python3-ldb \
    liblmdb-dev \
    python3-tdb \
    python3-urllib3 \
    python3-crypto \
    python3-gpg \
    libldap2-dev \
    libpopt-dev \
    python3-pyasn1 \
    python3-dnspython \
    libbsd-dev \
    python3-dev \
    python3-setuptools \
    python3-cryptography \
    python3-talloc \
    gdb \
    git \
    pkg-config \
    python3-dnspython \
    libarchive-dev \
    dnsutils \
    acl \
    attr \
    krb5-config \
    krb5-user \
    docbook-xml \
    docbook-xsl \
    xsltproc \
    docbook5-xml \
    docbook-xsl-ns \
    libjson-perl \
    xmlto \
    rsync \
    systemd

# Download and extract the Samba source code
RUN wget https://download.samba.org/pub/samba/samba-4.5.3.tar.gz && \
    tar -xzvf samba-4.5.3.tar.gz && \
    cd samba-4.5.3

# Configure and build Samba
RUN cd samba-4.5.3 && \
    ./configure && \
    make && \
    make install

# Expose the default Samba ports
EXPOSE 137/udp 138/udp 139/tcp 445/tcp

# Start Samba service
CMD ["/usr/local/samba/sbin/smbd", "--foreground", "--no-process-group"]
