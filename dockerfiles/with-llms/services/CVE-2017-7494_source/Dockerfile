# Use a base image with necessary dependencies
FROM ubuntu:20.04

# Install required packages
RUN apt-get update && \
    apt-get install -y build-essential wget python3-dev libgnutls28-dev libpam0g-dev libldap2-dev libbsd-dev python3 python3-pip && \
    rm -rf /var/lib/apt/lists/*

# Define version and download URL
ENV SAMBA_VERSION 4.4.13
ENV SAMBA_DOWNLOAD_URL https://download.samba.org/pub/samba/stable/samba-$SAMBA_VERSION.tar.gz

# Download and extract Samba source
RUN wget -O samba.tar.gz "$SAMBA_DOWNLOAD_URL" && \
    mkdir -p /usr/src/samba && \
    tar -xzvf samba.tar.gz -C /usr/src/samba --strip-components=1 && \
    rm samba.tar.gz

# Build and install Samba
RUN cd /usr/src/samba && \
    ./configure && \
    make && \
    make install

# Expose Samba ports
EXPOSE 137/udp 138/udp 139 445

# Define volumes
VOLUME ["/etc/samba", "/var/lib/samba"]

# Define entrypoint
ENTRYPOINT ["smbd", "--foreground", "--no-process-group"]
